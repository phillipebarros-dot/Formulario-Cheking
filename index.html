<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Formulário de Checking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    #pi-status { margin-top: 5px; font-size: 0.9em; }
    #error-message { color: #e74c3c; margin-top: 10px; display: none; }
    button { margin-top: 15px; padding: 10px 15px; background: #3498db; color: #fff; border: none; cursor: pointer; }
    button:hover { background: #2980b9; }
  </style>
</head>
<body>

  <h1>Formulário de Checking</h1>

  <form id="checking-form">
    <label for="telefone">Telefone *</label>
    <input type="text" id="telefone" placeholder="(00) 00000-0000">

    <label for="email">E-mail *</label>
    <input type="email" id="email" placeholder="seu@email.com">

    <label for="npi">Número da PI *</label>
    <input type="text" id="npi" placeholder="Digite o número da PI">
    <div id="pi-status"></div>

    <label for="cliente">Cliente *</label>
    <input type="text" id="cliente" placeholder="Nome do cliente">

    <label for="veiculo">Veículo *</label>
    <select id="veiculo">
      <option value="">Selecione o veículo</option>
      <option value="TV">TV</option>
      <option value="Rádio">Rádio</option>
      <option value="Online">Online</option>
      <option value="Outro">Outro</option>
    </select>
    <small>Este campo pode ser alterado manualmente.</small>

    <label for="campanha">Campanha *</label>
    <input type="text" id="campanha" placeholder="Nome da campanha">

    <label for="produto">Produto *</label>
    <input type="text" id="produto" placeholder="Nome do produto">

    <label for="periodo">Período *</label>
    <input type="text" id="periodo" placeholder="Período">

    <div id="error-message"></div>

    <button type="submit">Enviar</button>
  </form>

  <script>
    const npiInput = document.getElementById('npi');
    const clienteInput = document.getElementById('cliente');
    const veiculoSelect = document.getElementById('veiculo');
    const campanhaInput = document.getElementById('campanha');
    const produtoInput = document.getElementById('produto');
    const periodoInput = document.getElementById('periodo');
    const piStatus = document.getElementById('pi-status');
    const errorMessage = document.getElementById('error-message');

    let piFetchController = null;

    // Função para buscar dados da PI no n8n
    async function buscarDadosPI(npi) {
      if (!npi) {
        clienteInput.value = '';
        campanhaInput.value = '';
        produtoInput.value = '';
        periodoInput.value = '';
        piStatus.textContent = '';
        return;
      }

      if (piFetchController) piFetchController.abort();
      piFetchController = new AbortController();

      piStatus.textContent = 'Buscando dados da PI...';
      piStatus.style.color = '#3498db';
      errorMessage.style.display = 'none';

      try {
        const response = await fetch('https://n8n.grupoom.com.br/webhook/CheckingForm', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'buscar_pi', n_pi: npi }),
          signal: piFetchController.signal,
        });

        const data = await response.json();
        console.log('Resposta do n8n:', data);

        if (!response.ok) throw new Error(data.error || 'Erro de comunicação com o servidor.');

        if (Array.isArray(data) && data.length > 0) {
          const piInfo = data[0];
          piStatus.textContent = 'Dados da PI carregados.';
          piStatus.style.color = '#2ecc71';

          clienteInput.value = piInfo.CLIENTE || '';
          campanhaInput.value = piInfo.CAMPANHA || '';
          produtoInput.value = piInfo.PRODUTO || '';
          periodoInput.value = piInfo.PERIODO || '';

          if (!veiculoSelect.value && piInfo.MEIO) {
            veiculoSelect.value = piInfo.MEIO;
          }
        } else {
          piStatus.textContent = 'PI não encontrada.';
          piStatus.style.color = '#e74c3c';
          clienteInput.value = '';
          campanhaInput.value = '';
          produtoInput.value = '';
          periodoInput.value = '';
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          piStatus.textContent = error.message || 'Erro ao buscar dados da PI.';
          piStatus.style.color = '#e74c3c';
          clienteInput.value = '';
          campanhaInput.value = '';
          produtoInput.value = '';
          periodoInput.value = '';
        }
      }
    }

    // Dispara a busca ao digitar a PI
    npiInput.addEventListener('input', (e) => {
      const value = e.target.value.trim();
      if (value.length >= 3) {
        buscarDadosPI(value);
      } else {
        piStatus.textContent = '';
      }
    });

    // Submissão do formulário
    document.getElementById('checking-form').addEventListener('submit', (e) => {
      e.preventDefault();
      alert('Formulário enviado (apenas demonstração).');
    });
  </script>

</body>
</html>
