<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checking OpusMúltipla</title>
  <style>
    /* aparência fiel ao seu original + leves melhorias */
    body { font-family: Arial, sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
    .container { max-width: 760px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #243b4a; margin: 0 0 12px; font-size: 32px; }
    .attention-box { background:#fff8e1; border-left:6px solid #f39c12; padding:14px 18px; margin-bottom:18px; color:#b35e00; font-weight:600; border-radius:4px; }
    label { display:block; margin-top:12px; font-weight:600; color:#243b4a; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea {
      width:100%; padding:10px; margin-top:6px; border:1px solid #d0d7dc; border-radius:4px; font-size:15px; box-sizing:border-box;
    }
    textarea{ min-height:90px; resize:vertical; }
    .file-upload { margin-top:10px; border:2px dashed #ccc; padding:18px; text-align:center; cursor:pointer; border-radius:4px; color:#666; }
    .file-upload:hover { border-color:#3498db; color:#3498db; }
    .file-upload span{ font-weight:700; color:#3498db; text-decoration:underline; }
    .file-list{ margin-top:10px; }
    .file-item{ display:flex; justify-content:space-between; align-items:center; padding:8px; background:#fafafa; border-radius:4px; margin-bottom:6px; border:1px solid #eee; }
    .remove-btn{ background:#e74c3c; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:12px; }
    .controls{ display:flex; gap:10px; margin-top:14px; }
    button{ padding:12px 18px; border-radius:6px; border:none; background:#243b4a; color:white; font-size:16px; cursor:pointer; }
    button:hover{ opacity:0.95; }
    .small-muted{ font-size:13px; color:#666; }
    .loading-message{ color:#3498db; font-weight:700; margin-top:6px; }
    .success-message{ background:#2ecc71; color:white; padding:12px; border-radius:6px; margin-top:14px; display:none; text-align:center; }
    .error-message{ background:#e74c3c; color:white; padding:12px; border-radius:6px; margin-top:14px; display:none; text-align:center; }
    .debug-toggle{ color:#3498db; cursor:pointer; text-align:right; margin-top:10px; font-size:13px; }
    .debug-panel{ margin-top:12px; background:#fafafa; border:1px solid #e6e9ec; padding:10px; font-family:monospace; font-size:12px; max-height:240px; overflow:auto; white-space:pre-wrap; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>CHECKING OPUSMÚLTIPLA</h1>

    <div class="attention-box" role="alert" aria-live="assertive">
      ATENÇÃO<br/>
      Só aceitaremos checkings enviados por meio de arquivos; links não serão permitidos. O não envio conforme a PI pode gerar não pagamento das veiculações.
    </div>

    <form id="checkingForm" novalidate>
      <label for="nome">Nome *</label>
      <input id="nome" name="nome" type="text" placeholder="Seu nome completo" required />

      <label for="telefone">Telefone *</label>
      <input id="telefone" name="telefone" type="tel" placeholder="(00) 00000-0000" required />

      <label for="email">E-mail *</label>
      <input id="email" name="email" type="email" placeholder="seu@email.com" required />

      <label for="pi">Número da PI *</label>
      <input id="pi" name="pi" type="text" placeholder="Ex: 24-001" autocomplete="off" required aria-describedby="piStatus" />
      <div id="piStatus" class="loading-message" role="status" aria-live="polite"></div>

      <label for="cliente">Cliente *</label>
      <input id="cliente" name="cliente" type="text" placeholder="Nome do cliente" readonly required />

      <label for="veiculo">Veículo *</label>
      <select id="veiculo" name="veiculo" required>
        <option value="">Selecione o veículo</option>
        <option value="DO">DOOH - Digital Out of Home</option>
        <option value="ME">Mídia Exterior - MUB estático</option>
        <option value="MO">Mídia Exterior - Metrô estático</option>
        <option value="BD">Busdoor / Taxidoor</option>
        <option value="OD">Outdoor</option>
        <option value="FL">Fronts</option>
        <option value="MI">Mídia Interna</option>
        <option value="RD">Rádio</option>
        <option value="CI">Cinema</option>
        <option value="JO">Impressa - Jornal</option>
        <option value="RV">Impressa - Revista</option>
        <option value="AT">Ativação</option>
        <option value="TV">TV</option>
        <option value="IN">Internet</option>
      </select>
      <div class="small-muted">Este campo pode ser alterado manualmente.</div>

      <label for="campanha">Campanha *</label>
      <input id="campanha" name="campanha" type="text" placeholder="Nome da campanha" readonly required />

      <label for="produto">Produto *</label>
      <input id="produto" name="produto" type="text" placeholder="Nome do produto" readonly required />

      <label for="periodo">Período *</label>
      <input id="periodo" name="periodo" type="text" placeholder="Ex: 01/09/2025 a 30/09/2025" readonly required />

      <label for="observacoes">Observações</label>
      <textarea id="observacoes" name="observacoes" placeholder="Observações adicionais"></textarea>

      <label for="comprovantes">Insira os comprovantes (arquivos) *</label>
      <div class="file-upload" id="fileUpload" tabindex="0" role="button" aria-label="Arraste e solte arquivos ou clique">
        Arraste e solte os arquivos aqui ou <span>Navegar pelos arquivos</span>
        <input id="comprovantes" name="comprovantes" type="file" multiple accept=".jpg,.jpeg,.png,.pdf,.mp4,.mov" style="display:none" required />
      </div>
      <div id="fileList" class="file-list" aria-live="polite"></div>

      <div class="controls">
        <button type="button" id="checkPreflightBtn">Testar Preflight (OPTIONS)</button>
        <button type="submit" id="submitBtn">Enviar</button>
      </div>
    </form>

    <div class="success-message" id="successMessage" role="alert" aria-live="assertive">Formulário enviado com sucesso! Obrigado.</div>
    <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>

    <div class="debug-toggle" id="debugToggle">Mostrar detalhes de debug</div>
    <div class="debug-panel" id="debugPanel"></div>
  </div>

  <script>
  (function(){
    // ==================================================
    // CONFIGURE AQUI: coloque a URL EXATA do webhook n8n
    // ==================================================
    const WEBHOOK_URL = 'https://n8n.grupoom.com.br/webhook-test/CheckingForm';
    // ==================================================
    // Notas: o n8n deve responder OPTIONS para o mesmo path
    // e incluir os headers CORS (ver instruções abaixo).
    // ==================================================

    const form = document.getElementById('checkingForm');
    const fileUpload = document.getElementById('fileUpload');
    const fileInput = document.getElementById('comprovantes');
    const fileList = document.getElementById('fileList');
    const piInput = document.getElementById('pi');
    const piStatus = document.getElementById('piStatus');
    const clienteInput = document.getElementById('cliente');
    const campanhaInput = document.getElementById('campanha');
    const produtoInput = document.getElementById('produto');
    const periodoInput = document.getElementById('periodo');
    const veiculoSelect = document.getElementById('veiculo');
    const submitBtn = document.getElementById('submitBtn');
    const checkPreflightBtn = document.getElementById('checkPreflightBtn');
    const debugToggle = document.getElementById('debugToggle');
    const debugPanel = document.getElementById('debugPanel');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    let files = [];
    let piFetchController = null;
    let debounceTimeout = null;

    // debug UI
    debugToggle.addEventListener('click', ()=> {
      if (debugPanel.style.display === 'block') {
        debugPanel.style.display = 'none';
        debugToggle.textContent = 'Mostrar detalhes de debug';
      } else {
        debugPanel.style.display = 'block';
        debugToggle.textContent = 'Ocultar detalhes de debug';
      }
    });

    function logDebug(msg){
      const t = new Date().toLocaleTimeString();
      debugPanel.style.display = 'block';
      debugToggle.textContent = 'Ocultar detalhes de debug';
      debugPanel.innerText += `[${t}] ${msg}\n`;
      debugPanel.scrollTop = debugPanel.scrollHeight;
    }

    function showError(msg){
      errorMessage.innerText = msg;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
      logDebug('ERRO: ' + msg);
    }
    function showSuccess(msg){
      successMessage.innerText = msg;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
      logDebug('SUCESSO: ' + msg);
    }
    function hideMessages(){ errorMessage.style.display='none'; successMessage.style.display='none'; }

    // files UI
    fileUpload.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', (e)=> {
      for(const f of e.target.files) files.push(f);
      updateFileList();
    });
    fileUpload.addEventListener('dragover', e => { e.preventDefault(); fileUpload.style.borderColor='#3498db'; });
    fileUpload.addEventListener('dragleave', e => { e.preventDefault(); fileUpload.style.borderColor='#ccc'; });
    fileUpload.addEventListener('drop', e => { e.preventDefault(); fileUpload.style.borderColor='#ccc'; for(const f of e.dataTransfer.files) files.push(f); updateFileList(); });

    function updateFileList(){
      fileList.innerHTML = '';
      files.forEach((file, idx) => {
        const div = document.createElement('div'); div.className='file-item';
        const span = document.createElement('span'); span.textContent = file.name;
        const btn = document.createElement('button'); btn.type='button'; btn.className='remove-btn'; btn.textContent='Remover';
        btn.addEventListener('click', ()=> { files.splice(idx,1); updateFileList(); });
        div.appendChild(span); div.appendChild(btn); fileList.appendChild(div);
      });
    }

    // ============================
    // BUSCAR PI (JSON)
    // ============================
    async function buscarDadosPI(npi){
      if(!npi){ clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex = 0; piStatus.textContent=''; return; }
      if(piFetchController) piFetchController.abort();
      piFetchController = new AbortController();
      piStatus.textContent = 'Buscando dados da PI...';
      piStatus.style.color = '#3498db';
      hideMessages();

      const payload = { action:'buscar_pi', n_pi: npi.toString().trim() };
      logDebug('Enviando busca PI: ' + JSON.stringify(payload));
      logDebug('URL: ' + WEBHOOK_URL);

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
          body: JSON.stringify(payload),
          signal: piFetchController.signal
        });

        logDebug(`Response status: ${res.status} ${res.statusText}`);
        try { logDebug('Response headers: '+ JSON.stringify([...res.headers.entries()])); } catch(e){}

        const ct = (res.headers.get('content-type') || '').toLowerCase();
        let data;
        if (ct.includes('application/json')) {
          data = await res.json().catch(()=>{ throw new Error('Resposta JSON inválida'); });
        } else {
          const txt = await res.text().catch(()=>'');
          logDebug('Response body (raw): ' + txt);
          try { data = txt ? JSON.parse(txt) : {}; } catch(e){ if(!res.ok) throw new Error('Erro ' + res.status); else throw new Error('Resposta não-JSON'); }
        }

        if (!res.ok) {
          const msg = (data && (data.error || data.message)) || `Erro ${res.status}`;
          piStatus.textContent = msg; piStatus.style.color = '#e74c3c';
          clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex=0;
          logDebug('Busca retornou erro: ' + msg);
          return;
        }

        // sucesso esperado
        logDebug('Resposta parseada: ' + JSON.stringify(data));
        if (data && (data.success === true || data.cliente || data.CLIENTER)) {
          piStatus.textContent = 'Dados da PI carregados com sucesso.'; piStatus.style.color = '#2ecc71';
          clienteInput.value = data.cliente || data.CLIENTE || '';
          campanhaInput.value = data.campanha || data.CAMPANHA || '';
          produtoInput.value = data.produto || data.PRODUTO || '';
          periodoInput.value = data.periodo || data.PERIODO || '';
          if (veiculoSelect.selectedIndex === 0 && (data.veiculo || data.VEICULO)) veiculoSelect.value = data.veiculo || data.VEICULO;
        } else {
          piStatus.textContent = data && (data.error || 'Resposta inesperada do servidor.') || 'Resposta inesperada do servidor.'; piStatus.style.color = '#e74c3c';
          clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex=0;
          logDebug('Resposta sem success: '+JSON.stringify(data));
        }

      } catch (err) {
        logDebug('Erro na busca PI: ' + err);
        if (err.name === 'AbortError') { /* cancelado */ }
        else {
          const m = (err.message||'').toLowerCase();
          if (m.includes('failed to fetch') || m.includes('cors') || m.includes('network')) {
            piStatus.textContent = 'Erro de CORS. Verifique o webhook (OPTIONS) no n8n ou o proxy.'; 
          } else piStatus.textContent = err.message || 'Erro ao buscar dados da PI.';
          piStatus.style.color = '#e74c3c';
          clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex=0;
        }
      } finally {
        piFetchController = null;
      }
    }

    piInput.addEventListener('input', ()=> {
      clearTimeout(debounceTimeout);
      debounceTimeout = setTimeout(()=> {
        const v = piInput.value.trim();
        if (v) buscarDadosPI(v);
        else { piStatus.textContent=''; clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex=0; }
      }, 450);
    });

    // ============================
    // SUBMISSÃO (FormData)
    // ============================
    form.addEventListener('submit', async e => {
      e.preventDefault(); hideMessages();

      if (files.length === 0) { showError('Por favor, insira pelo menos um arquivo de comprovante.'); return; }

      const required = ['nome','telefone','email','pi','cliente','veiculo','campanha','produto','periodo'];
      for (const f of required) {
        const el = document.getElementById(f);
        if (!el || !el.value.trim()) { showError('Por favor preencha o campo ' + (el ? el.previousElementSibling.textContent.replace(' *','') : f)); el && el.focus(); return; }
      }

      submitBtn.disabled = true; submitBtn.textContent = 'Enviando...';

      try {
        const formData = new FormData();
        formData.append('action','submissao');
        formData.append('nome', document.getElementById('nome').value.trim());
        formData.append('telefone', document.getElementById('telefone').value.trim());
        formData.append('email', document.getElementById('email').value.trim());
        formData.append('pi', document.getElementById('pi').value.trim());
        formData.append('cliente', document.getElementById('cliente').value.trim());
        formData.append('veiculo', document.getElementById('veiculo').value);
        formData.append('campanha', document.getElementById('campanha').value.trim());
        formData.append('produto', document.getElementById('produto').value.trim());
        formData.append('periodo', document.getElementById('periodo').value.trim());
        formData.append('observacoes', document.getElementById('observacoes').value.trim());
        files.forEach((file,i)=> formData.append(`comprovante_${i}`, file));
        formData.append('total_arquivos', String(files.length));

        logDebug('Enviando FormData (resumo):');
        for (let pair of formData.entries()) {
          if (pair[1] instanceof File) logDebug(`${pair[0]}: File(${pair[1].name}, ${pair[1].size})`);
          else logDebug(`${pair[0]}: ${pair[1]}`);
        }

        const res = await fetch(WEBHOOK_URL, { method:'POST', mode:'cors', body: formData });
        logDebug(`Submit status: ${res.status} ${res.statusText}`);
        try { logDebug('Submit headers: ' + JSON.stringify([...res.headers.entries()])); } catch(e){}

        let respObj = {};
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if (ct.includes('application/json')) respObj = await res.json().catch(()=>({}));
        else {
          const text = await res.text().catch(()=>'');
          logDebug('Submit response text: ' + text);
          try { respObj = text ? JSON.parse(text) : {}; } catch(e) {}
        }

        if (!res.ok) throw new Error(respObj.message || respObj.error || `Erro ${res.status}`);

        if (respObj && respObj.success) {
          showSuccess(respObj.message || 'Formulário enviado com sucesso!');
          form.reset(); files = []; updateFileList(); piStatus.textContent=''; clienteInput.value=campanhaInput.value=produtoInput.value=periodoInput.value=''; veiculoSelect.selectedIndex=0;
        } else throw new Error(respObj.message || respObj.error || 'O servidor retornou erro.');
      } catch (err) {
        logDebug('Erro no envio: ' + err);
        const m = (err && err.message || '').toLowerCase();
        if (m.includes('failed to fetch')||m.includes('cors')||m.includes('network')) showError('Erro de conexão/CORS. Verifique o webhook (OPTIONS) no n8n e os headers CORS.');
        else showError('Erro ao enviar formulário: ' + (err.message || err));
      } finally {
        submitBtn.disabled = false; submitBtn.textContent = 'Enviar';
      }
    });

    // botão para testar preflight (opcional)
    checkPreflightBtn.addEventListener('click', async ()=> {
      logDebug('Executando OPTIONS ' + WEBHOOK_URL);
      try {
        const r = await fetch(WEBHOOK_URL, { method:'OPTIONS', mode:'cors' });
        logDebug('Preflight status: ' + r.status + ' ' + r.statusText);
        try { logDebug('Preflight headers: ' + JSON.stringify([...r.headers.entries()])); } catch(e){}
        if (!r.ok) logDebug('Preflight retornou erro — corrija RespondToWebhook/OPTIONS no n8n ou proxy.');
      } catch(e) { logDebug('Preflight falhou: ' + e); showError('Preflight falhou: possivel problema CORS/proxy. Verifique console e n8n.'); }
    });

    // inicial
    debugPanel.style.display = 'none';
    logDebug('Interface carregada. Ajuste WEBHOOK_URL no topo se necessário.');
  })();
  </script>
</body>
</html>
