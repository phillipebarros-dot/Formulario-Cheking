<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checking OpusMúltipla</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
    .container { max-width: 760px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.08); }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 8px; }
    .attention-box { background-color: #fff8e1; border-left: 6px solid #f39c12; padding: 15px 20px; margin-bottom: 20px; font-weight: bold; color: #b35e00; font-size: 0.95rem; border-radius: 4px; }
    label { display: block; margin-top: 12px; font-weight: bold; color: #2c3e50; }
    input[type="text"], input[type="email"], input[type="tel"], select, textarea { width: 100%; padding: 10px; margin-top: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; box-sizing: border-box; }
    textarea { resize: vertical; }
    .file-upload { margin-top: 10px; border: 2px dashed #ccc; padding: 20px; text-align: center; cursor: pointer; border-radius: 4px; color: #666; user-select: none; }
    .file-upload:hover { border-color: #3498db; color: #3498db; }
    .file-upload span { font-weight: bold; color: #3498db; text-decoration: underline; cursor: pointer; }
    .file-list { margin-top: 10px; }
    .file-item { margin-bottom: 5px; font-size: 14px; color: #333; display: flex; justify-content: space-between; align-items: center; padding: 8px; background-color: #f9f9f9; border-radius: 4px; }
    button { margin-top: 18px; width: 100%; padding: 14px; background-color: #2c3e50; color: white; font-size: 17px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease; }
    button:hover { background-color: #1a252f; }
    button:disabled { background-color: #95a5a6; cursor: not-allowed; }
    .success-message { background-color: #2ecc71; color: white; padding: 12px; border-radius: 6px; margin-top: 14px; display: none; text-align: center; }
    .error-message { background-color: #e74c3c; color: white; padding: 12px; border-radius: 6px; margin-top: 14px; display: none; text-align: center; }
    .loading-message { color: #3498db; font-weight: bold; margin-top: 6px; font-size: 0.95rem; }
    .remove-btn { background-color: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .remove-btn:hover { background-color: #c0392b; }
    .debug-panel { margin-top: 18px; padding: 12px; background-color: #f8f9fa; border: 1px solid #e6e9ec; border-radius: 6px; font-family: monospace; font-size: 12px; max-height: 260px; overflow-y: auto; display: none; white-space: pre-wrap; }
    .debug-toggle { color: #3498db; cursor: pointer; font-size: 13px; margin-top: 8px; text-align: right; user-select: none; }
    .controls { display:flex; gap:10px; margin-top:10px; }
    .controls button { width:auto; padding:8px 12px; font-size:13px; }
    .small-muted { font-size:12px; color:#666; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>CHECKING OPUSMÚLTIPLA</h1>
    <div class="attention-box" role="alert" aria-live="assertive">
      ATENÇÃO<br />
      Só aceitaremos checkings enviados por meio de arquivos; links não serão permitidos. Leia as instruções na PI.
    </div>

    <form id="checkingForm" novalidate>
      <label for="nome">Nome *</label>
      <input type="text" id="nome" name="nome" required placeholder="Seu nome completo" />

      <label for="telefone">Telefone *</label>
      <input type="tel" id="telefone" name="telefone" required placeholder="(00) 00000-0000" />

      <label for="email">E-mail *</label>
      <input type="email" id="email" name="email" required placeholder="seu@email.com" />

      <label for="pi">Número da PI *</label>
      <input type="text" id="pi" name="pi" required placeholder="Ex: 24-001" aria-describedby="piStatus" autocomplete="off" />
      <div id="piStatus" class="loading-message" aria-live="polite" role="status"></div>

      <label for="cliente">Cliente *</label>
      <input type="text" id="cliente" name="cliente" required placeholder="Nome do cliente" readonly />

      <label for="veiculo">Veículo *</label>
      <select id="veiculo" name="veiculo" required aria-describedby="veiculoHelp">
        <option value="">Selecione o veículo</option>
        <option value="DO">DOOH - Digital Out of Home</option>
        <option value="ME">Mídia Exterior - MUB estático</option>
        <option value="MO">Mídia Exterior - Metrô estático</option>
        <option value="BD">Mídia Exterior - Busdoor/Taxidoor</option>
        <option value="OD">Mídia Exterior - Outdoor</option>
        <option value="FL">Mídia Exterior - Fronts</option>
        <option value="MI">Mídia Interna estática</option>
        <option value="RD">Rádio</option>
        <option value="CI">Cinema</option>
        <option value="JO">Mídia Impressa - Jornal</option>
        <option value="RV">Mídia Impressa - Revista</option>
        <option value="AT">Projetos Especiais - Ativação</option>
        <option value="TV">TV</option>
        <option value="IN">Internet</option>
      </select>
      <small id="veiculoHelp" class="small-muted">Este campo pode ser alterado manualmente.</small>

      <label for="campanha">Campanha *</label>
      <input type="text" id="campanha" name="campanha" required placeholder="Nome da campanha" readonly />

      <label for="produto">Produto *</label>
      <input type="text" id="produto" name="produto" required placeholder="Nome do produto" readonly />

      <label for="periodo">Período *</label>
      <input type="text" id="periodo" name="periodo" required placeholder="Ex: 01/09/2025 a 30/09/2025" readonly />

      <label for="observacoes">Observações</label>
      <textarea id="observacoes" name="observacoes" rows="4" placeholder="Observações adicionais"></textarea>

      <label for="comprovantes">Insira os comprovantes (arquivos) *</label>
      <div class="file-upload" id="fileUpload" tabindex="0" role="button" aria-label="Área para arrastar e soltar arquivos ou clicar para navegar">
        Arraste e solte os arquivos aqui ou <span>Navegar pelos arquivos</span>
        <input type="file" id="comprovantes" name="comprovantes" multiple accept=".jpg,.jpeg,.png,.pdf,.mp4,.mov" style="display:none" required />
      </div>
      <div class="file-list" id="fileList" aria-live="polite" role="region" aria-label="Lista de arquivos selecionados"></div>

      <div class="controls">
        <button type="button" id="checkPreflightBtn">Testar Preflight (OPTIONS)</button>
        <button type="submit" id="submitBtn">Enviar</button>
      </div>
    </form>

    <div class="success-message" id="successMessage" role="alert" aria-live="assertive">Formulário enviado com sucesso! Obrigado.</div>
    <div class="error-message" id="errorMessage" role="alert" aria-live="assertive"></div>

    <div class="debug-toggle" id="debugToggle">Mostrar detalhes de debug</div>
    <div class="debug-panel" id="debugPanel"></div>
  </div>

  <script>
    (function () {
      // ========== CONFIG ==========
      // Coloque aqui a URL do webhook exatamente como no n8n (ex.: https://n8n.grupoom.com.br/webhook-test/CheckingForm)
      const WEBHOOK_URL = 'https://n8n.grupoom.com.br/webhook-test/CheckingForm';

      // Observação importante:
      // No n8n: o nodo RespondToWebhook / Responder Preflight deve ter:
      //   Access-Control-Allow-Origin: *
      //   Access-Control-Allow-Methods: GET, POST, OPTIONS
      //   Access-Control-Allow-Headers: Content-Type, Accept, X-Requested-With
      //   Access-Control-Max-Age: 86400
      // E responseCode numérico (204 para OPTIONS, 200 para POST).
      // ============================

      const form = document.getElementById('checkingForm');
      const fileUpload = document.getElementById('fileUpload');
      const fileInput = document.getElementById('comprovantes');
      const fileList = document.getElementById('fileList');
      const successMessage = document.getElementById('successMessage');
      const errorMessage = document.getElementById('errorMessage');
      const piInput = document.getElementById('pi');
      const piStatus = document.getElementById('piStatus');
      const clienteInput = document.getElementById('cliente');
      const campanhaInput = document.getElementById('campanha');
      const produtoInput = document.getElementById('produto');
      const periodoInput = document.getElementById('periodo');
      const veiculoSelect = document.getElementById('veiculo');
      const submitBtn = document.getElementById('submitBtn');
      const debugToggle = document.getElementById('debugToggle');
      const debugPanel = document.getElementById('debugPanel');
      const checkPreflightBtn = document.getElementById('checkPreflightBtn');

      let files = [];
      let piFetchController = null;

      // Debug panel
      debugToggle.addEventListener('click', () => {
        if (debugPanel.style.display === 'block') {
          debugPanel.style.display = 'none';
          debugToggle.textContent = 'Mostrar detalhes de debug';
        } else {
          debugPanel.style.display = 'block';
          debugToggle.textContent = 'Ocultar detalhes de debug';
        }
      });

      function logDebug(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugPanel.style.display = 'block';
        debugToggle.textContent = 'Ocultar detalhes de debug';
        debugPanel.innerText += `[${timestamp}] ${message}\n`;
        debugPanel.scrollTop = debugPanel.scrollHeight;
      }

      // File UI
      fileUpload.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        for (const f of e.target.files) files.push(f);
        updateFileList();
      });
      fileUpload.addEventListener('dragover', (e) => { e.preventDefault(); fileUpload.style.borderColor = '#3498db'; });
      fileUpload.addEventListener('dragleave', (e) => { e.preventDefault(); fileUpload.style.borderColor = '#ccc'; });
      fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.style.borderColor = '#ccc';
        for (const f of e.dataTransfer.files) files.push(f);
        updateFileList();
      });

      function updateFileList() {
        fileList.innerHTML = '';
        files.forEach((file, index) => {
          const div = document.createElement('div');
          div.className = 'file-item';
          const fileName = document.createElement('span');
          fileName.textContent = file.name;
          div.appendChild(fileName);
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button'; removeBtn.textContent = 'Remover'; removeBtn.className = 'remove-btn';
          removeBtn.onclick = () => { files.splice(index, 1); updateFileList(); };
          div.appendChild(removeBtn);
          fileList.appendChild(div);
        });
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        logDebug(`ERRO: ${msg}`);
      }

      function showSuccess(msg) {
        successMessage.textContent = msg;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        logDebug(`SUCESSO: ${msg}`);
      }

      function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
      }

      // ============================
      // BUSCAR DADOS DA PI (JSON)
      // ============================
      async function buscarDadosPI(npi) {
        if (!npi) {
          clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
          veiculoSelect.selectedIndex = 0;
          piStatus.textContent = '';
          return;
        }

        if (piFetchController) piFetchController.abort();
        piFetchController = new AbortController();

        piStatus.textContent = 'Buscando dados da PI...';
        piStatus.style.color = '#3498db';
        hideMessages();

        const payload = { action: 'buscar_pi', n_pi: npi.toString().trim() };
        logDebug(`Enviando busca PI (JSON): ${JSON.stringify(payload)}`);
        logDebug(`URL utilizada: ${WEBHOOK_URL}`);

        try {
          const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            mode: 'cors',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(payload),
            signal: piFetchController.signal
          });

          logDebug(`Response status: ${response.status} ${response.statusText}`);
          // Print response headers (array)
          try {
            const headersArr = [...response.headers.entries()];
            logDebug(`Response headers: ${JSON.stringify(headersArr)}`);
          } catch (e) {
            logDebug(`Erro ao ler headers: ${e}`);
          }

          // Parse body if JSON, otherwise raw text
          const contentType = response.headers.get('content-type') || '';
          let dataText = '';
          if (contentType.includes('application/json')) {
            try {
              const data = await response.json();
              dataText = JSON.stringify(data);
              logDebug(`Response JSON: ${dataText}`);
              handlePIResponse(response.status, data);
            } catch (e) {
              logDebug(`Erro parseando JSON: ${e}`);
              throw new Error('Resposta JSON inválida do servidor');
            }
          } else {
            // fallback: raw text
            dataText = await response.text().catch(() => '');
            logDebug(`Response body (raw): ${dataText}`);
            // Try to parse if possible
            try {
              const parsed = dataText ? JSON.parse(dataText) : {};
              handlePIResponse(response.status, parsed);
            } catch (e) {
              // Not JSON
              if (!response.ok) {
                throw new Error(`Erro ${response.status}: ${response.statusText}`);
              }
              // response ok but non-JSON
              throw new Error('Resposta inesperada do servidor (não JSON).');
            }
          }
        } catch (error) {
          logDebug(`Erro na busca PI: ${error}`);
          if (error.name === 'AbortError') {
            // ignore
          } else {
            // Detect possible CORS / network
            const msg = (error.message || '').toLowerCase();
            if (msg.includes('failed to fetch') || msg.includes('networkerror') || msg.includes('cors')) {
              piStatus.textContent = 'Erro de CORS. Verifique o webhook (OPTIONS) no n8n ou o proxy.';
            } else {
              piStatus.textContent = error.message || 'Erro ao buscar dados da PI.';
            }
            piStatus.style.color = '#e74c3c';
            clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
            veiculoSelect.selectedIndex = 0;
          }
        } finally {
          piFetchController = null;
        }
      }

      function handlePIResponse(status, data) {
        if (!status || status >= 400) {
          const err = (data && (data.error || data.message)) || `Erro ${status}`;
          piStatus.textContent = err;
          piStatus.style.color = '#e74c3c';
          clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
          veiculoSelect.selectedIndex = 0;
          return;
        }

        if (data && data.error) {
          piStatus.textContent = data.error;
          piStatus.style.color = '#e74c3c';
          clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
          veiculoSelect.selectedIndex = 0;
          return;
        }

        // Caso esperado: success true ou campos diretos
        if (data && (data.success === true || data.cliente || data.campanha || data.produto || data.periodo)) {
          piStatus.textContent = 'Dados da PI carregados com sucesso.';
          piStatus.style.color = '#2ecc71';
          clienteInput.value = data.cliente || data.CLIENTE || '';
          campanhaInput.value = data.campanha || data.CAMPANHA || '';
          produtoInput.value = data.produto || data.PRODUTO || '';
          periodoInput.value = data.periodo || data.PERIODO || '';
          if (veiculoSelect.selectedIndex === 0 && (data.veiculo || data.VEICULO)) {
            veiculoSelect.value = data.veiculo || data.VEICULO;
          }
        } else {
          piStatus.textContent = 'Resposta inesperada do servidor.';
          piStatus.style.color = '#e74c3c';
          clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
          veiculoSelect.selectedIndex = 0;
          logDebug(`Resposta sem success nem error: ${JSON.stringify(data)}`);
        }
      }

      // debounce input
      let debounceTimeout;
      piInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
          const piValue = piInput.value.trim();
          if (piValue) buscarDadosPI(piValue);
          else {
            piStatus.textContent = '';
            clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
            veiculoSelect.selectedIndex = 0;
          }
        }, 450);
      });

      // ============================
      // SUBMISSÃO (multipart/form-data)
      // ============================
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        hideMessages();

        if (files.length === 0) { showError('Por favor, insira pelo menos um arquivo de comprovante.'); return; }

        const requiredFields = ['nome', 'telefone', 'email', 'pi', 'cliente', 'veiculo', 'campanha', 'produto', 'periodo'];
        for (const field of requiredFields) {
          const input = document.getElementById(field);
          if (!input.value.trim()) {
            showError(`Por favor, preencha o campo ${input.previousElementSibling.textContent.replace(' *', '')}.`);
            input.focus();
            return;
          }
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
          const formData = new FormData();
          formData.append('action', 'submissao');
          formData.append('nome', document.getElementById('nome').value.trim());
          formData.append('telefone', document.getElementById('telefone').value.trim());
          formData.append('email', document.getElementById('email').value.trim());
          formData.append('pi', document.getElementById('pi').value.trim());
          formData.append('cliente', document.getElementById('cliente').value.trim());
          formData.append('veiculo', document.getElementById('veiculo').value);
          formData.append('campanha', document.getElementById('campanha').value.trim());
          formData.append('produto', document.getElementById('produto').value.trim());
          formData.append('periodo', document.getElementById('periodo').value.trim());
          formData.append('observacoes', document.getElementById('observacoes').value.trim());

          // anexos: nomeamos como comprovante_0, comprovante_1, ... (compatível com seu n8n)
          files.forEach((file, index) => formData.append(`comprovante_${index}`, file));
          formData.append('total_arquivos', files.length.toString());

          logDebug('Enviando FormData: (lista resumida)');
          for (let [k, v] of formData.entries()) {
            if (v instanceof File) logDebug(`${k}: File(${v.name}, ${v.size})`);
            else logDebug(`${k}: ${v}`);
          }

          const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            mode: 'cors',
            body: formData
            // IMPORTANT: do NOT set Content-Type when sending FormData — browser sets the boundary
          });

          logDebug(`Submit response status: ${response.status} ${response.statusText}`);
          try { logDebug(`Submit headers: ${JSON.stringify([...response.headers.entries()])}`); } catch(e){}

          // Try parse JSON if returned
          let responseData = {};
          const ct = response.headers.get('content-type') || '';
          if (ct.includes('application/json')) {
            responseData = await response.json().catch(() => ({}));
            logDebug(`Submit response JSON: ${JSON.stringify(responseData)}`);
          } else {
            const text = await response.text().catch(()=>'');
            logDebug(`Submit response text: ${text}`);
            try { responseData = text ? JSON.parse(text) : {}; } catch(e) { /* ignore */ }
          }

          if (!response.ok) {
            throw new Error(responseData.message || responseData.error || `Erro ${response.status}: ${response.statusText}`);
          }

          if (responseData && responseData.success) {
            showSuccess(responseData.message || 'Formulário enviado com sucesso! Obrigado.');
            form.reset();
            files = [];
            updateFileList();
            piStatus.textContent = '';
            clienteInput.value = campanhaInput.value = produtoInput.value = periodoInput.value = '';
            veiculoSelect.selectedIndex = 0;
          } else {
            throw new Error(responseData.message || responseData.error || 'Ocorreu um erro no servidor.');
          }
        } catch (error) {
          logDebug(`Erro no envio: ${error}`);
          const msg = (error && error.message) ? error.message : 'Erro ao enviar formulário.';
          if (msg.toLowerCase().includes('failed to fetch') || msg.toLowerCase().includes('networkerror') || msg.toLowerCase().includes('cors')) {
            showError('Erro de conexão/CORS. Verifique o webhook (OPTIONS) no n8n e os headers CORS.');
          } else {
            showError('Erro ao enviar formulário: ' + msg);
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enviar';
        }
      });

      // ============================
      // Preflight manual test (opcional)
      // ============================
      checkPreflightBtn.addEventListener('click', async () => {
        logDebug('Executando teste preflight (OPTIONS) — pode falhar por CORS se o servidor não aceitar.');
        try {
          const resp = await fetch(WEBHOOK_URL, {
            method: 'OPTIONS',
            mode: 'cors'
          });
          logDebug(`Preflight status: ${resp.status} ${resp.statusText}`);
          try {
            const hdrs = [...resp.headers.entries()];
            logDebug(`Preflight headers: ${JSON.stringify(hdrs)}`);
          } catch (e) {
            logDebug(`Erro ao ler headers do preflight: ${e}`);
          }
          if (resp.ok) logDebug('Preflight OK (respondeu).');
          else logDebug('Preflight respondeu com erro; verifique RespondToWebhook/OPTIONS no n8n ou proxy.');
        } catch (e) {
          logDebug('Preflight falhou: possível CORS ou bloqueio pelo proxy. ' + e);
        }
      });

      // Small UX: press Enter in PI input to trigger immediate search
      piInput.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter') {
          ev.preventDefault();
          const v = piInput.value.trim();
          if (v) buscarDadosPI(v);
        }
      });

      // Init debug panel collapsed
      debugPanel.style.display = 'none';

      // Helpful initial debug note
      logDebug('Interface carregada. Verifique WEBHOOK_URL e headers CORS no n8n se houver problemas.');
    })();
  </script>
</body>
</html>
