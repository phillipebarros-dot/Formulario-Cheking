# Documenta√ß√£o T√©cnica do Workflow n8n

## üìã √çndice

- [Vis√£o Geral](#vis√£o-geral)
- [Arquitetura do Workflow](#arquitetura-do-workflow)
- [Fluxo Detalhado](#fluxo-detalhado)
- [Documenta√ß√£o dos N√≥s](#documenta√ß√£o-dos-n√≥s)
- [C√≥digos JavaScript](#c√≥digos-javascript)
- [Tratamento de Erros](#tratamento-de-erros)
- [Otimiza√ß√µes e Performance](#otimiza√ß√µes-e-performance)
- [Manuten√ß√£o e Monitoramento](#manuten√ß√£o-e-monitoramento)

## Vis√£o Geral

O workflow n8n do formul√°rio de checking processa duas opera√ß√µes principais atrav√©s de um √∫nico webhook:

1. **Busca de PI:** Consulta dados da planilha para auto-preenchimento
2. **Submiss√£o de Checking:** Valida, organiza no Drive e notifica

### Especifica√ß√µes T√©cnicas

| Item | Valor |
|------|-------|
| **Webhook URL** | `https://n8n.grupoom.com.br/webhook/CheckingForm` |
| **M√©todo HTTP** | POST |
| **Timeout** | 3600s (60 minutos) |
| **Max Payload** | 800MB |
| **Total de N√≥s** | 19 n√≥s |
| **Execu√ß√µes Paralelas** | Suportado |

## Arquitetura do Workflow

### Diagrama Visual

```mermaid
graph TD
    A[Webhook POST] --> B{√â Busca de PI?}
    
    B -->|Sim| C[Buscar PI no Sheets]
    C --> D[Formatar Resposta PI]
    D --> E[Responder JSON PI]
    
    B -->|N√£o| F[Validar Submiss√£o]
    F --> G{Valida√ß√£o OK?}
    
    G -->|N√£o| H[Responder Erro]
    
    G -->|Sim| I{√â Link do Drive?}
    
    I -->|Sim| J[Preparar Log Link]
    J --> K[Unificar Fluxos]
    
    I -->|N√£o| L[Buscar Pasta Cliente]
    L --> M{Pasta Existe?}
    
    M -->|N√£o| N[Criar Pasta Cliente]
    N --> O[Definir ID Cliente]
    M -->|Sim| O
    
    O --> P[Criar Pasta PI]
    P --> Q[Separar Cada Arquivo]
    Q --> R[Upload Arquivo Drive]
    R --> S[Aguardar Todos Uploads]
    S --> T[Preparar Log Binary]
    T --> K
    
    K --> U[Registrar Log Sheets]
    K --> V[Enviar E-mail]
    V --> W[Responder Sucesso]
```

### Estrutura de Dados

#### Entrada - Busca de PI
```json
{
  "action": "buscar_pi",
  "n_pi": "182429"
}
```

#### Entrada - Submiss√£o
```json
{
  "action": "submissao_form",
  "nome": "string",
  "email": "string",
  "telefone": "string",
  "n_pi": "string",
  "cliente": "string",
  "campanha": "string",
  "produto": "string",
  "periodo": "string",
  "veiculo": "string",
  "meio": "string",
  "observacoes": "string",
  "upload_method": "binary",
  "relatorio_fotografico_do": "File[]",
  // ... outros arquivos
}
```

## Fluxo Detalhado

### 1Ô∏è‚É£ Rota de Busca de PI

#### N√≥ 1: Webhook POST
**Tipo:** `n8n-nodes-base.webhook`
**Configura√ß√£o:**
```yaml
httpMethod: POST
path: CheckingForm
responseMode: responseNode
webhookId: checking-form-post
```

**Descri√ß√£o:** Recebe todas as requisi√ß√µes POST. O corpo da requisi√ß√£o √© disponibilizado em `$json.body`.

---

#### N√≥ 2: √â Busca de PI?
**Tipo:** `n8n-nodes-base.if`
**Condi√ß√£o:**
```javascript
$json.body.action === "buscar_pi"
```

**Descri√ß√£o:** Roteia para busca se `action` for `"buscar_pi"`, caso contr√°rio vai para submiss√£o.

---

#### N√≥ 3: Buscar PI no Sheets
**Tipo:** `n8n-nodes-base.googleSheets`
**Opera√ß√£o:** Read
**Configura√ß√£o:**
```yaml
documentId: "1iwUay2RE8k1PumivMbEjuzIyw4CBaktJ2YPsR1iwe_Q"
sheetName: "gid=0"  # Aba principal
filtersUI:
  - lookupColumn: "N_PI"
    lookupValue: "={{ $json.body.n_pi }}"
```

**Descri√ß√£o:** Busca linha onde coluna `N_PI` corresponde ao n√∫mero fornecido.

**Sa√≠da Esperada:**
```json
[
  {
    "N_PI": "182429",
    "CLIENTE": "NOME CLIENTE",
    "CAMPANHA": "CAMPANHA",
    "PRODUTO": "PRODUTO",
    "PERIODO": "01/01/2025 - 31/01/2025",
    "VEICULO": "VEICULO",
    "MEIO": "DO",
    "STATUS": "ativa"
  }
]
```

---

#### N√≥ 4: Formatar Resposta PI
**Tipo:** `n8n-nodes-base.code`
**C√≥digo:**
```javascript
const items = $input.all();

if (items.length === 0 || !items[0].json.N_PI) {
  return [{ 
    json: { 
      success: false, 
      error: 'PI n√£o encontrada' 
    } 
  }];
}

const pi = items[0].json;

return [{
  json: {
    success: true,
    cliente: pi.CLIENTE || '',
    campanha: pi.CAMPANHA || '',
    produto: pi.PRODUTO || '',
    periodo: pi.PERIODO || '',
    veiculo: pi.VEICULO || '',
    meio: pi.MEIO || ''
  }
}];
```

**Descri√ß√£o:** Transforma dados do Sheets em resposta JSON padronizada.

---

#### N√≥ 5: Responder JSON PI
**Tipo:** `n8n-nodes-base.respondToWebhook`
**Configura√ß√£o:**
```yaml
respondWith: json
responseBody: "={{ $json }}"
```

**Descri√ß√£o:** Envia resposta de volta ao formul√°rio.

---

### 2Ô∏è‚É£ Rota de Submiss√£o

#### N√≥ 6: Validar Submiss√£o
**Tipo:** `n8n-nodes-base.code`
**C√≥digo Completo:**
```javascript
const item = $input.item;
const body = item.json.body || {};
const binary = item.binary || {};
const erros = [];

// 1. Validar campos obrigat√≥rios
const camposObrigatorios = ['nome', 'email', 'telefone', 'n_pi'];
const camposFaltando = camposObrigatorios.filter(
  campo => !body[campo] || body[campo].trim() === ''
);

if (camposFaltando.length > 0) {
  erros.push(`Campos obrigat√≥rios faltando: ${camposFaltando.join(', ')}`);
}

// 2. Verificar m√©todo de upload
const uploadMethod = body.upload_method;
const driveLink = body.drive_link;

if (uploadMethod === 'drive_link') {
  // Validar link do Drive
  if (!driveLink || !driveLink.includes('drive.google.com')) {
    erros.push('Link do Google Drive inv√°lido.');
  } else {
    const matchFolder = driveLink.match(/folders\/([a-zA-Z0-9_-]+)/);
    const matchFile = driveLink.match(/[-\w]{25,}/);
    
    if (matchFolder) {
      item.json.driveFolderId = matchFolder[1];
      item.json.uploadMethod = 'drive_link';
    } else if (matchFile) {
      item.json.driveFolderId = matchFile[0];
      item.json.uploadMethod = 'drive_link';
    } else {
      erros.push('N√£o foi poss√≠vel extrair o ID do link do Drive.');
    }
  }
} else {
  // Validar anexos bin√°rios
  item.json.uploadMethod = 'binary';
  const meio = body.meio;
  
  const anexosRequeridosPorMeio = {
    'DO': ['relatorio_fotografico_do', 'relatorio_exibicoes_do', 'video_diurno_do'],
    'ME': ['relatorio_enderecos_me', 'fotos_pontos_me'],
    'MO': ['relatorio_estacoes_mo', 'fotos_videos_mo'],
    'BD': ['comprovante_bd'],
    'OD': ['comprovante_od_fl'],
    'FL': ['comprovante_od_fl'],
    'MI': ['comprovante_mi'],
    'AT': ['comprovante_geral'],
    'CI': ['comprovante_geral'],
    'IN': ['comprovante_geral'],
    'JO': ['comprovante_geral'],
    'RD': ['comprovante_geral'],
    'RV': ['comprovante_geral'],
    'TV': ['comprovante_geral'],
    'TP': ['comprovante_geral']
  };

  const camposAnexoRequeridos = anexosRequeridosPorMeio[meio];

  if (!meio) {
    erros.push('Campo Meio n√£o preenchido.');
  } else if (!camposAnexoRequeridos) {
    erros.push(`Meio '${meio}' n√£o possui regras de anexo definidas.`);
  } else {
    const anexosFaltando = [];
    
    camposAnexoRequeridos.forEach(campo => {
      const temArquivo = Object.keys(binary).some(key => {
        return key === campo || key.startsWith(campo + '_');
      });
      
      if (!temArquivo) {
        anexosFaltando.push(campo);
      }
    });
    
    if (anexosFaltando.length > 0) {
      erros.push(`Anexos obrigat√≥rios faltando: ${anexosFaltando.join(', ')}`);
    }
  }
}

item.json.validationResult = erros.length > 0
  ? { success: false, message: erros.join('; ') }
  : { success: true, message: 'Valida√ß√£o conclu√≠da.' };

return [item];
```

**Descri√ß√£o:** Valida√ß√£o completa de campos e arquivos. Suporta dois m√©todos de upload:
- **binary:** Arquivos anexados diretamente (< 500MB)
- **drive_link:** Link para pasta do Drive j√° criada (‚â• 500MB)

---

#### N√≥ 7: Valida√ß√£o OK?
**Tipo:** `n8n-nodes-base.if`
**Condi√ß√£o:**
```javascript
Boolean($json.validationResult?.success) === true
```

**Descri√ß√£o:** Verifica se n√£o houve erros na valida√ß√£o. Caso contr√°rio, retorna erro 400.

---

#### N√≥ 8: Responder Erro
**Tipo:** `n8n-nodes-base.respondToWebhook`
**Configura√ß√£o:**
```yaml
respondWith: json
responseBody: "={{ { \"success\": false, \"message\": $json.validationResult.message || \"Erro na valida√ß√£o.\" } }}"
options:
  responseCode: 400
```

**Descri√ß√£o:** Retorna mensagem de erro detalhada ao front-end.

---

#### N√≥ 9: √â Link do Drive?
**Tipo:** `n8n-nodes-base.if`
**Condi√ß√£o:**
```javascript
$json.uploadMethod === "drive_link"
```

**Descri√ß√£o:** Separa fluxo para uploads via link (‚â•500MB) vs bin√°rios (<500MB).

---

### 3Ô∏è‚É£ Rota: Link do Drive (‚â•500MB)

#### N√≥ 10: Preparar Log Link
**Tipo:** `n8n-nodes-base.code`
**C√≥digo:**
```javascript
const submissionData = $items('Validar Submiss√£o')[0].json;
const body = submissionData.body;

return [{
  json: {
    n_pi: body.n_pi || 'N/A',
    cliente: body.cliente || 'N/A',
    veiculo: body.veiculo || 'N/A',
    nome: body.nome || 'N/A',
    email: body.email || 'N/A',
    telefone: body.telefone || 'N/A',
    meio: body.meio || 'N/A',
    observacoes: body.observacoes || '',
    totalArquivos: 'Via Link Drive',
    uploadMethod: 'drive_link',
    webViewLink: body.drive_link || 'Link n√£o fornecido'
  }
}];
```

**Descri√ß√£o:** Prepara dados para log quando usu√°rio fornece link do Drive.

---

### 4Ô∏è‚É£ Rota: Upload Bin√°rio (<500MB)

#### N√≥ 11: Buscar Pasta Cliente
**Tipo:** `n8n-nodes-base.googleDrive`
**Opera√ß√£o:** Search
**Configura√ß√£o:**
```yaml
searchMethod: query
queryString: "={{ \"name='\" + $items('Validar Submiss√£o')[0].json.body.cliente.trim().toUpperCase() + \"' and mimeType='application/vnd.google-apps.folder' and '1OEL4MtYKd5Tg-ZOmsIRG9RQkvfX-xs_s' in parents and trashed=false\" }}"
```

**Descri√ß√£o:** Busca pasta do cliente dentro da pasta raiz "Checkings". O ID `1OEL4MtYKd5Tg-ZOmsIRG9RQkvfX-xs_s` √© a pasta raiz.

**Query traduzida:**
```
name='NOME_CLIENTE' 
and mimeType='application/vnd.google-apps.folder' 
and '1OEL4MtYKd5Tg-ZOmsIRG9RQkvfX-xs_s' in parents 
and trashed=false
```

---

#### N√≥ 12: Pasta Cliente Existe?
**Tipo:** `n8n-nodes-base.if`
**Condi√ß√£o:**
```javascript
$json.id != null
```

**Descri√ß√£o:** Verifica se a busca retornou uma pasta. Se n√£o, cria nova pasta.

---

#### N√≥ 13: Criar Pasta Cliente
**Tipo:** `n8n-nodes-base.googleDrive`
**Opera√ß√£o:** Create Folder
**Configura√ß√£o:**
```yaml
name: "={{ $items('Validar Submiss√£o')[0].json.body.cliente.toUpperCase() }}"
folderId: "1OEL4MtYKd5Tg-ZOmsIRG9RQkvfX-xs_s"  # Pasta raiz Checkings
```

**Descri√ß√£o:** Cria pasta com nome do cliente em UPPERCASE dentro da pasta raiz.

---

#### N√≥ 14: Definir ID da Pasta Cliente
**Tipo:** `n8n-nodes-base.set`
**Configura√ß√£o:**
```yaml
assignments:
  - name: clientFolderId
    value: "={{ $json.id }}"
    type: string
```

**Descri√ß√£o:** Captura o ID da pasta (encontrada ou criada) para usar na pr√≥xima etapa.

---

#### N√≥ 15: Criar Pasta PI
**Tipo:** `n8n-nodes-base.googleDrive`
**Opera√ß√£o:** Create Folder
**Configura√ß√£o:**
```yaml
name: "={{ 'PI ' + $items('Validar Submiss√£o')[0].json.body.n_pi + ' - ' + $items('Validar Submiss√£o')[0].json.body.cliente.replace(/[\/\\?%*:|\"<>]/g, '-') + ' - ' + $now.toFormat(\"dd-MM-yyyy HH'h'mm\") }}"
folderId: "={{ $json.clientFolderId }}"
```

**Exemplo de nome gerado:**
```
PI 182429 - CLIENTE XYZ - 15-10-2025 14h30
```

**Descri√ß√£o:** Cria pasta espec√≠fica da PI dentro da pasta do cliente, com timestamp.

---

#### N√≥ 16: Separar Cada Arquivo
**Tipo:** `n8n-nodes-base.code`
**C√≥digo:**
```javascript
const submissionItem = $items('Validar Submiss√£o')[0];
const piFolderId = $json.id;

const binary = submissionItem.binary || {};
const arquivos = [];

let totalArquivos = 0;

for (const key in binary) {
  totalArquivos++;
  arquivos.push({
    json: {
      ...submissionItem.json,
      piFolderId: piFolderId,
      nomeArquivoOriginal: binary[key].fileName || `arquivo_${totalArquivos}`,
      mimeType: binary[key].mimeType || 'application/octet-stream',
      totalArquivos: 0
    },
    binary: {
      data: binary[key]
    }
  });
}

// Atualizar total em todos os itens
arquivos.forEach(item => {
  item.json.totalArquivos = totalArquivos;
});

return arquivos.length > 0 ? arquivos : [{ json: { erro: 'Nenhum arquivo encontrado' } }];
```

**Descri√ß√£o:** Converte objeto com m√∫ltiplos arquivos bin√°rios em array de itens individuais para upload paralelo.

**Entrada:**
```javascript
{
  binary: {
    relatorio_fotografico_do: File1,
    relatorio_exibicoes_do: File2,
    video_diurno_do: File3
  }
}
```

**Sa√≠da:**
```javascript
[
  { json: {...}, binary: { data: File1 } },
  { json: {...}, binary: { data: File2 } },
  { json: {...}, binary: { data: File3 } }
]
```

---

#### N√≥ 17: Upload Arquivo no Drive
**Tipo:** `n8n-nodes-base.googleDrive`
**Opera√ß√£o:** Upload
**Configura√ß√£o:**
```yaml
folderId: "={{ $json.piFolderId }}"
```

**Descri√ß√£o:** Faz upload de cada arquivo individualmente na pasta da PI. Executa em paralelo para todos os arquivos.

---

#### N√≥ 18: Aguardar Todos Uploads
**Tipo:** `n8n-nodes-base.merge`
**Modo:** Combine All
**Configura√ß√£o:**
```yaml
mode: combine
combineBy: combineAll
```

**Descri√ß√£o:** Aguarda conclus√£o de todos os uploads paralelos antes de prosseguir.

---

#### N√≥ 19: Preparar Log Binary
**Tipo:** `n8n-nodes-base.code`
**C√≥digo:**
```javascript
const todosUploads = $input.all();
const submissionData = $items('Validar Submiss√£o')[0].json.body;
const pastaPi = $items('Criar Pasta PI')[0].json;

return [{
  json: {
    n_pi: submissionData.n_pi || 'N/A',
    cliente: submissionData.cliente || 'N/A',
    veiculo: submissionData.veiculo || 'N/A',
    nome: submissionData.nome || 'N/A',
    email: submissionData.email || 'N/A',
    telefone: submissionData.telefone || 'N/A',
    meio: submissionData.meio || 'N/A',
    observacoes: submissionData.observacoes || '',
    totalArquivos: todosUploads.length,
    uploadMethod: 'binary',
    webViewLink: pastaPi.webViewLink || 'https://drive.google.com/drive/folders/' + pastaPi.id
  }
}];
```

**Descri√ß√£o:** Consolida informa√ß√µes de todos os uploads em um √∫nico objeto para log.

---

### 5Ô∏è‚É£ Unifica√ß√£o e Finaliza√ß√£o

#### N√≥ 20: Unificar Fluxos
**Tipo:** `n8n-nodes-base.merge`
**Descri√ß√£o:** Une os dados vindos do fluxo de link e do fluxo bin√°rio em um √∫nico fluxo.

---

#### N√≥ 21: Registrar Log no Sheets
**Tipo:** `n8n-nodes-base.googleSheets`
**Opera√ß√£o:** Append
**Configura√ß√£o:**
```yaml
documentId: "1iwUay2RE8k1PumivMbEjuzIyw4CBaktJ2YPsR1iwe_
