

```markdown
# An√°lise T√©cnica Detalhada do Workflow n8n

Este documento oferece uma an√°lise t√©cnica detalhada, n√≥ por n√≥, do workflow de automa√ß√£o do formul√°rio de checking. O objetivo √© servir como um manual para manuten√ß√£o, depura√ß√£o e futuras evolu√ß√µes do processo.

### Fluxo Geral da Automa√ß√£o

`Formul√°rio Web` ‚ûî `1. Webhook` ‚ûî `2. Identificar A√ß√£o` ‚ûî `3. IF A√ß√£o` ‚ûî `[Rota de Busca]` OU `[Rota de Envio Completo]`

---

## An√°lise Detalhada dos N√≥s (Node-by-Node)

### 1. Webhook (Recebe do Front-End)
* **Tipo de N√≥:** `Webhook`
* **Objetivo:** Ponto de entrada da automa√ß√£o. Gera uma URL √∫nica que "escuta" as requisi√ß√µes enviadas pelo formul√°rio.
* **Configura√ß√£o Chave:** `HTTP Method: POST`, `Path: CheckingForm`, `Response Mode: responseNode`.

### 2. Identificar A√ß√£o
* **Tipo de N√≥:** `Function`
* **Objetivo:** "Traduzir" a inten√ß√£o do usu√°rio, diferenciando uma busca de PI de uma submiss√£o completa.
* **C√≥digo JavaScript:**
    ```javascript
    const body = $json.body || {};
    if (body.action === 'buscar_pi') {
      return [{ json: { tipo: 'buscar_pi', n_pi: body.n_pi } }];
    } else {
      return [{ json: { tipo: 'submissao', dados: $item.json } }];
    }
    ```

### 3. IF A√ß√£o
* **Tipo de N√≥:** `IF`
* **Objetivo:** Roteador principal do workflow.
* **Configura√ß√£o Chave:** Condi√ß√£o que verifica se `tipo == 'buscar_pi'`.
    * **Sa√≠da `true`:** Leva para a **Rota de Busca**.
    * **Sa√≠da `false`:** Leva para a **Rota de Envio Completo**.

---

### Rota de Busca (Fluxo R√°pido de Consulta)

#### 4a. Buscar PI (dados)
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Consultar a planilha para buscar os dados da PI solicitada.

#### 5a. Montar Resposta PI
* **Tipo de N√≥:** `Function`
* **Objetivo:** Formatar a resposta (JSON) que ser√° enviada de volta ao formul√°rio.
* **C√≥digo JavaScript:**
    ```javascript
    const piData = $json;
    if (!piData || Object.keys(piData).length <= 1) {
      return [{ json: { error: 'PI n√£o encontrada ou inativa.' } }];
    }
    return [{
      json: {
        success: true,
        cliente: piData.CLIENTE || '',
        campanha: piData.CAMPANHA || '',
        produto: piData.PRODUTO || '',
        periodo: piData.PERIODO || '',
        veiculo: piData.VEICULO || '',
        meio: piData.MEIO || ''
      }
    }];
    ```

#### 6a. Responder Dados PI
* **Tipo de N√≥:** `Respond to Webhook`
* **Objetivo:** Enviar a resposta para o formul√°rio e terminar a execu√ß√£o.

---

### Rota de Envio Completo (Fluxo Principal)

#### 4b. Buscar PI (submissao)
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Revalidar a exist√™ncia da PI no momento do envio final.

#### 5b. Verificar PI Existe
* **Tipo de N√≥:** `IF`
* **Objetivo:** Primeiro ponto de verifica√ß√£o. Garante que o fluxo s√≥ continue se a PI for encontrada.
* **Sa√≠da `true` (PI n√£o existe):** Leva para `Responder Erro PI`.
* **Sa√≠da `false` (PI existe):** Continua para `Validar Status PI`.

#### 6b. Responder Erro PI
* **Tipo de N√≥:** `Respond to Webhook`
* **Objetivo:** Enviar uma mensagem de erro ao usu√°rio e encerrar o workflow caso a PI n√£o seja encontrada.

#### 7b. Validar Status PI
* **Tipo de N√≥:** `Function`
* **Objetivo:** Garantir que o checking s√≥ seja aceito para PIs com status "ativa".
* **C√≥digo JavaScript:**
    ```javascript
    const piData = $json;
    if (!piData.Status || piData.Status.toLowerCase() !== 'ativa') {
      throw new Error('A PI informada n√£o est√° ativa e n√£o pode receber checkings.');
    }
    return $json;
    ```

#### 8b. Cadeia de Valida√ß√£o de Anexos (`IF Ve√≠culo √© ME?`, `IF Ve√≠culo √© DO?`, etc.)
* **Tipo de N√≥s:** `IF`, `Function`
* **Objetivo:** Verificar se a quantidade de arquivos enviados atende ao m√≠nimo exigido para cada tipo de "Meio".
* **L√≥gica:** Uma sequ√™ncia de n√≥s `IF` verifica o valor de `$json.dados.body.meio`. Se for um tipo que exige valida√ß√£o, o fluxo √© direcionado para um n√≥ `Function` espec√≠fico que conta os anexos e dispara um erro (`throw new Error`) se a contagem for insuficiente. Se n√£o for um tipo especial, o fluxo pula esta etapa.

#### 9b. Criar Pasta PI
* **Tipo de N√≥:** `Google Drive`
* **Objetivo:** Ponto de converg√™ncia. Cria uma pasta √∫nica para os comprovantes.
* **Configura√ß√£o Chave:** `Operation: Create Folder`, `Name: PI_{{$json.dados.body.n_pi}}`.

#### 10b. Upload Arquivos
* **Tipo de N√≥:** `Google Drive`
* **Objetivo:** Salvar os arquivos do formul√°rio na pasta criada.

#### 11b. Registrar Log
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Criar a trilha de auditoria na planilha `Log_Checkings`.

#### 12b. Enviar Notifica√ß√£o
* **Tipo de N√≥:** `Send Email`
* **Objetivo:** Enviar o e-mail de confirma√ß√£o para a equipe.

#### 13b. Responder Sucesso
* **Tipo de N√≥:** `Respond to Webhook`
* **Objetivo:** Enviar a mensagem final de sucesso para o formul√°rio e encerrar o workflow.

---

### üß™ Testando o Fluxo de Envio com Seguran√ßa

Para testar o workflow sem criar pastas, registrar logs ou enviar e-mails reais, utilize uma das seguintes estrat√©gias:

#### M√©todo 1: Desativar N√≥s (Simples e R√°pido)
1.  Na interface do n8n, clique com o **bot√£o direito** nos n√≥s de produ√ß√£o (`Criar Pasta PI`, `Upload Arquivos`, `Registrar Log`, `Enviar Notifica√ß√£o`).
2.  Selecione **"Deactivate" (Desativar)**. Os n√≥s ficar√£o cinza.
3.  Execute o workflow a partir do formul√°rio. O fluxo de dados ir√° parar nos n√≥s desativados.
4.  Clique em um n√≥ desativado e inspecione sua aba **"Input"** para verificar se os dados que chegaram at√© ali est√£o corretos.
5.  Lembre-se de reativar os n√≥s ("Activate") quando terminar os testes.

#### M√©todo 2: Usar um "PI de Teste" com um N√≥ IF (Avan√ßado)
1.  Defina um n√∫mero de PI que ser√° usado apenas para testes (ex: `TESTE-999`).
2.  No workflow, adicione um n√≥ `IF` antes do `Criar Pasta PI`.
3.  Configure a condi√ß√£o para verificar se a PI √© a de teste: `{{$json.dados.body.n_pi}}` `Equals` `TESTE-999`.
4.  Conecte a sa√≠da **`false`** (envio real) ao restante do fluxo (`Criar Pasta PI`).
5.  Deixe a sa√≠da **`true`** (√© um teste) desconectada. Isso far√° com que qualquer execu√ß√£o com a PI de teste pare nesse ponto de forma segura.
