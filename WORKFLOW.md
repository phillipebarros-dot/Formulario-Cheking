

### **Etapa 1: Exporte o Arquivo do seu Workflow**

Primeiro, voc√™ precisa extrair o "c√≥digo-fonte" do seu workflow do n8n.

1.  Abra seu workflow na interface do n8n.
2.  No canto superior esquerdo, clique no menu **"File"** (Arquivo).
3.  V√° em **"Export"** -\> **"Export to File"**.
4.  Selecione **"JSON"** como o formato.
5.  Salve o arquivo no seu computador. Para manter um padr√£o, renomeie-o para **`workflow.json`**.

### **Etapa 2: Adicione os Arquivos ao seu Reposit√≥rio GitHub**

Agora, vamos fazer o upload do `workflow.json` e criar o novo arquivo de documenta√ß√£o.

1.  **Fa√ßa o upload do `workflow.json`:**

      * Acesse seu reposit√≥rio no GitHub.
      * Clique em **"Add file"** \> **"Upload files"**.
      * Arraste o arquivo **`workflow.json`** que voc√™ salvou para a √°rea de upload.
      * Escreva uma mensagem de commit (ex: `Adiciona arquivo JSON do workflow n8n`) e clique em **"Commit changes"**.

2.  **Crie o arquivo de documenta√ß√£o `WORKFLOW.md`:**

      * Na p√°gina principal do seu reposit√≥rio, clique em **"Add file"** \> **"Create new file"**.
      * No campo para o nome do arquivo, digite: **`WORKFLOW.md`**
      * No campo grande de edi√ß√£o, **copie e cole todo o conte√∫do** que preparei para voc√™ abaixo.
      * Escreva uma mensagem de commit (ex: `Cria documenta√ß√£o t√©cnica detalhada do workflow`) e clique em **"Commit changes"**.

### **Etapa 3: Vincule a Nova Documenta√ß√£o no `README.md` (Recomendado)**

Para que todos encontrem facilmente esta nova documenta√ß√£o, vamos adicionar um link a ela no seu `README.md` principal.

1.  Edite seu arquivo `README.md`.

2.  Encontre a se√ß√£o `## ü§ñ Como Funciona a Automa√ß√£o (n8n)`.

3.  No final dessa se√ß√£o, adicione a seguinte linha:

    ```markdown
    Para uma an√°lise t√©cnica detalhada de cada n√≥ do workflow, **[consulte a documenta√ß√£o completa aqui](./WORKFLOW.md)**.
    ```

-----

### **Conte√∫do para o Arquivo `WORKFLOW.md` (Copie tudo abaixo)**

````markdown
# An√°lise T√©cnica Detalhada do Workflow n8n

Este documento oferece uma an√°lise t√©cnica detalhada, n√≥ por n√≥, do workflow de automa√ß√£o do formul√°rio de checking. O objetivo √© servir como um manual para manuten√ß√£o, depura√ß√£o e futuras evolu√ß√µes do processo.

### Fluxo Geral da Automa√ß√£o

`Formul√°rio Web` ‚ûî `1. Webhook` ‚ûî `2. Identificar A√ß√£o` ‚ûî `3. IF A√ß√£o` ‚ûî `[Rota de Busca]` OU `[Rota de Envio Completo]`

---

## An√°lise Detalhada dos N√≥s (Node-by-Node)

### 1. Webhook (Recebe do Front-End)
* **Tipo de N√≥:** `Webhook`
* **Objetivo:** √â a porta de entrada da automa√ß√£o. Gera uma URL √∫nica que fica "escutando" as requisi√ß√µes enviadas pelo formul√°rio `index.html`.
* **Configura√ß√£o Chave:**
    * **HTTP Method:** `POST` - Permite o recebimento de dados, incluindo o upload de arquivos (`multipart/form-data`).
    * **Path:** `CheckingForm` - Define o endere√ßo final da URL.
    * **Response Mode:** `responseNode` - Delega a tarefa de enviar a resposta de volta ao formul√°rio para um n√≥ espec√≠fico (`Respond to Webhook`), permitindo fluxos mais complexos.

### 2. Identificar A√ß√£o
* **Tipo de N√≥:** `Function` (Code)
* **Objetivo:** Atua como um "tradutor" da inten√ß√£o do usu√°rio. Ele inspeciona os dados recebidos para determinar se a requisi√ß√£o √© uma busca de PI ou uma submiss√£o de formul√°rio.
* **C√≥digo JavaScript:**
    ```javascript
    const body = $json.body || {};
    if (body.action === 'buscar_pi') {
      // Se for uma busca, cria um item simples com o tipo 'buscar_pi' e o n_pi.
      return [{ json: { tipo: 'buscar_pi', n_pi: body.n_pi } }];
    } else {
      // Para a submiss√£o, cria um item com o tipo 'submissao' e anexa todos os dados originais.
      return [{ json: { tipo: 'submissao', dados: $item.json } }];
    }
    ```

### 3. IF A√ß√£o
* **Tipo de N√≥:** `IF`
* **Objetivo:** √â o principal roteador do workflow. Com base na sa√≠da do n√≥ anterior, direciona a execu√ß√£o para o caminho correto.
* **Configura√ß√£o Chave:**
    * **Condi√ß√£o:** Verifica se o campo `tipo` √© igual a `buscar_pi`.
    * **Sa√≠da `true`:** Leva para a **Rota de Busca**.
    * **Sa√≠da `false`:** Leva para a **Rota de Envio Completo**.

---

### Rota de Busca (Fluxo R√°pido de Consulta)

#### 4a. Buscar PI (dados)
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Consultar a planilha para verificar se a PI existe e buscar seus dados.
* **Configura√ß√£o Chave:**
    * **Operation:** `Get Many` (Ler linhas).
    * **Sheet:** Aba `base`.
    * **Filters:** `N_PI` (coluna) `Equals` `{{$json.n_pi}}`.

#### 5a. Montar Resposta PI
* **Tipo de N√≥:** `Function` (Code)
* **Objetivo:** Formatar a resposta (JSON) que ser√° enviada de volta ao formul√°rio, seja com os dados encontrados ou com uma mensagem de erro.
* **C√≥digo JavaScript:**
    ```javascript
    const piData = $json;
    // Verifica se a busca retornou um objeto com dados.
    if (!piData || Object.keys(piData).length <= 1) {
      return [{ json: { error: 'PI n√£o encontrada' } }];
    }
    // Se encontrou, retorna um JSON de sucesso com os dados formatados.
    return [{
      json: {
        success: true,
        cliente: piData.CLIENTE || '',
        campanha: piData.CAMPANHA || '',
        produto: piData.PRODUTO || '',
        periodo: piData.PERIODO || '',
        veiculo: piData.VEICULO || '',
        meio: piData.MEIO || ''
      }
    }];
    ```

#### 6a. Responder Dados PI
* **Tipo de N√≥:** `Respond to Webhook`
* **Objetivo:** Enviar a resposta (JSON de sucesso ou erro) para o JavaScript do formul√°rio e **terminar esta execu√ß√£o do workflow**.

---

### Rota de Envio Completo (Fluxo Principal)

#### 4b. Buscar PI (submissao)
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Revalidar a exist√™ncia da PI e obter os dados para uso posterior (ex: nome do cliente para o e-mail).
* **Configura√ß√£o Chave:**
    * **Filters:** `N_PI` `Equals` `{{$json.dados.body.n_pi}}`.

#### 5b. Verificar PI Existe
* **Tipo de N√≥:** `IF`
* **Objetivo:** Parar o fluxo se a PI enviada no formul√°rio final n√£o existir.
* **Configura√ß√£o Chave:**
    * **Condi√ß√£o:** Verifica se o n√∫mero de resultados da busca anterior √© igual a `0`.

#### 6b. Validar Status PI
* **Tipo de N√≥:** `Function` (Code)
* **Objetivo:** Garantir que o checking s√≥ seja aceito para PIs com status "ativa".
* **C√≥digo JavaScript:**
    ```javascript
    const piData = $json;
    if (!piData.Status || piData.Status.toLowerCase() !== 'ativa') {
      // Interrompe o workflow e retorna uma mensagem de erro ao usu√°rio.
      throw new Error('A PI informada n√£o est√° ativa e n√£o pode receber checkings.');
    }
    return $json;
    ```

#### 7b. Valida√ß√µes de Anexos (Cadeia de IFs e Functions)
* **Tipo de N√≥s:** `IF`, `Function`
* **Objetivo:** Verificar se a quantidade de arquivos enviados atende ao m√≠nimo exigido para cada tipo de "Meio".
* **Configura√ß√£o Chave:** Os `IF`s verificam o valor de `$json.dados.body.meio` e direcionam para `Function`s que contam os anexos e disparam um erro (`throw new Error`) se a contagem for insuficiente.

#### 8b. Criar Pasta PI
* **Tipo de N√≥:** `Google Drive`
* **Objetivo:** Criar uma pasta √∫nica e padronizada para os comprovantes.
* **Configura√ß√£o Chave:**
    * **Operation:** `Create Folder`.
    * **Name:** `PI_{{$json.dados.body.n_pi}}` (express√£o din√¢mica).

#### 9b. Upload Arquivos
* **Tipo de N√≥:** `Google Drive`
* **Objetivo:** Salvar os arquivos enviados pelo usu√°rio na pasta rec√©m-criada.
* **Configura√ß√£o Chave:**
    * **Operation:** `Upload File`.
    * **Binary Property:** `dados.binary.comprovantes` (aponta para os dados dos arquivos).
    * **Parent Folder ID:** `{{$node["Criar Pasta PI"].json.id}}` (usa o ID da pasta criada no passo anterior).

#### 10b. Registrar Log
* **Tipo de N√≥:** `Google Sheets`
* **Objetivo:** Criar uma trilha de auditoria, registrando cada submiss√£o bem-sucedida.
* **Configura√ß√£o Chave:**
    * **Operation:** `Append` (Adicionar linha).
    * **Sheet:** Aba `Log_Checkings`.
    * **Columns:** Mapeia os dados relevantes (`PI`, `Cliente`, `Data`, etc.) para as colunas da planilha.

#### 11b. Enviar Notifica√ß√£o
* **Tipo de N√≥:** `Send Email`
* **Objetivo:** Comunicar √† equipe interna que um novo checking foi recebido.
* **Configura√ß√£o Chave:**
    * **To/From/Subject/Body:** Campos preenchidos com os e-mails dos destinat√°rios e conte√∫do din√¢mico usando express√µes.

#### 12b. Responder Sucesso
* **Tipo de N√≥:** `Respond to Webhook`
* **Objetivo:** Enviar a mensagem final de sucesso de volta para o formul√°rio e **terminar esta execu√ß√£o do workflow**.
